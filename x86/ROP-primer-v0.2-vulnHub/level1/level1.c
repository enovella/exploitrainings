#include <stdio.h>
#include <stdlib.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <unistd.h>
#include <fcntl.h>

void write_buf(int fd, char *buf)
{
  int len = strlen(buf);
  write(fd, buf, len);
}


void write_file(char *filename, char *filebuf, int filesize)
{
  int f = open(filename, O_RDWR | O_CREAT, S_IRUSR | S_IWUSR);
  write(f, filebuf, filesize);
  close(f);
}

void handle_conn(int fd)
{
  char filename[32], cmd[32];
  char text[256];
  int read_bytes, filesize;
  char str_filesize[7];

  // banner
  write_buf(fd, "Welcome to \n");
  write_buf(fd, " XERXES File Storage System\n");
  write_buf(fd, "  available commands are:\n");
  write_buf(fd, "  store, read, exit.\n");

  while (1)
  {
      write_buf(fd, "\n> ");

      memset(cmd, 0, sizeof(cmd));
      read(fd, cmd, sizeof(cmd));

      if (!strncmp(cmd, "store", 5))
      {
          write_buf(fd, " Please, how many bytes is your file?\n\n");
          write_buf(fd, "> ");
          memset(str_filesize, 0, sizeof(str_filesize));

          read(fd, &str_filesize, 6);
          filesize = atoi(str_filesize);
          char *filebuf = malloc(filesize);

          write_buf(fd, " Please, send your file:\n\n");
          write_buf(fd, "> ");
  
          read_bytes = read(fd, filebuf, filesize);

          if (read_bytes == filesize)
          {
              write_buf(fd, "   XERXES is pleased to inform you\n    that your file was received\n        most successfully.\n");
          }
          else
          {
              write_buf(fd, "   XERXES regrets to inform you\n    that an error occurred\n        while receiving your file.\n");
          }

          write_buf(fd, " Please, give a filename:\n");
          write_buf(fd, "> ");

          memset(filename, 0, sizeof(filename));           
          read_bytes = read(fd, filename, filesize);

          snprintf(text, sizeof(text), "  XERXES will store\n   this data as '%s'.\n", filename);
          write_buf(fd, text);

          write_file(filename, filebuf, filesize);

          write_buf(fd, "  XERXES wishes you\n      a NICE day.\n");
          return;
      }

      if (!strncmp(cmd, "read", 4))
      {
          write_buf(fd, "  Please, give a filename to read:\n");
          write_buf(fd, "> ");
          
          memset(filename, 0, sizeof(filename));           
          read_bytes = read(fd, filename, sizeof(filename));
          filename[read_bytes-1] = 0;

          if (strstr(filename, "flag"))
          {
              write_buf(fd, "  XERXES demands your capture\n    or destruction.\n  Have a NICE day.\n");
              return;
          }
          
          int f = open(filename, O_RDONLY);
          if (f == -1)
          {
              write_buf(fd, "  XERXES regrets to inform you\n   that the requested file cannot be found.\n");   
          }
      
          char *filebuf = malloc(100000);
          read_bytes = read(f, filebuf, 100000);
          write(fd, filebuf, read_bytes);
          free(filebuf);

          write_buf(fd, "  XERXES wishes you\n      a NICE day.\n");
          return;
      }

      if (!strncmp(cmd, "exit", 4))
      {
          write_buf(fd, "  XERXES wishes you\n      a NICE day.\n");
          return;
      }
  }
}

int main(int argc, char **argv)
{
  int listenfd = -1, connfd = -1;
  struct sockaddr_in serv_addr;

  listenfd = socket(AF_INET, SOCK_STREAM, 0);
  memset(&serv_addr, 0, sizeof(serv_addr));

  serv_addr.sin_family = AF_INET;
  serv_addr.sin_addr.s_addr = htonl(INADDR_ANY);
  serv_addr.sin_port = htons(8888);

  while (bind(listenfd, (struct sockaddr*)&serv_addr, sizeof(serv_addr)) < 0)
  {
      printf("[!] error bind()ing!\n");
      sleep(1);
      printf("[+] retrying bind()\n");
  }

  listen(listenfd, 10);    // 10 = backlog?

  while (1)
  {
      connfd = accept(listenfd, (struct sockaddr*)NULL, NULL);
      int pid = fork();
      if (pid < 0)
      {
          printf("[!] error fork()ing!\n");
          close(listenfd);
          exit(-1);
      }
      if (pid == 0)
      {
          close(listenfd);
          handle_conn(connfd);
          close(connfd);
          exit(0);
      }

      close(connfd);
  }

  return 0;
}